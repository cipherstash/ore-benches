[tools]
rust = "latest"

[tasks.postgres]
description = "Start PostgreSQL via Docker Compose"
run = "docker compose up -d postgres"

[tasks.postgres-stop]
description = "Stop PostgreSQL Docker container"
run = "docker compose down"

[tasks.postgres-logs]
description = "View PostgreSQL logs"
run = "docker compose logs -f postgres"

[tasks.psql]
description = "Connect to PostgreSQL via psql"
run = "docker exec -it ore-benches-postgres psql -U postgres -d postgres"

[tasks.reset-db]
description = "Reset the database (drop and recreate)"
depends = ["postgres"]
run = """
#!/usr/bin/env bash
set -e

echo "Waiting for PostgreSQL to be ready..."
until docker exec ore-benches-postgres pg_isready -U postgres > /dev/null 2>&1; do
  sleep 1
done

echo "Dropping and recreating database..."
docker exec -i ore-benches-postgres psql -U postgres -d template1 -c "DROP DATABASE IF EXISTS postgres WITH (FORCE);"
docker exec -i ore-benches-postgres psql -U postgres -d template1 -c "CREATE DATABASE postgres;"

echo "Database reset complete. Run 'mise run setup-db' to set up tables and data."
"""

[tasks.setup-db]
description = "Set up the test database (create tables and load data)"
depends = ["postgres"]
run = """
#!/usr/bin/env bash
set -e

echo "Waiting for PostgreSQL to be ready..."
until docker exec ore-benches-postgres pg_isready -U postgres > /dev/null 2>&1; do
  sleep 1
done

echo "Downloading EQL..."
curl -sLo /tmp/cipherstash-encrypt.sql https://github.com/cipherstash/encrypt-query-language/releases/latest/download/cipherstash-encrypt.sql

echo "Installing EQL..."
docker exec -i ore-benches-postgres psql -v ON_ERROR_STOP=1 -U postgres -d postgres < /tmp/cipherstash-encrypt.sql

echo "Creating tables..."
docker exec -i ore-benches-postgres psql -v ON_ERROR_STOP=1 -U postgres -d postgres < sql/schema.sql

echo "Database setup complete!"
"""

[tasks."bench:ingest:_run"]
description = "Internal: Run a generic ingest benchmark"
run = """
#!/usr/bin/env bash
set -e

BENCH_NAME="$1"

if [ -z "$BENCH_NAME" ]; then
  echo "Error: BENCH_NAME argument must be provided"
  exit 1
fi

echo "Running $BENCH_NAME ingest benchmark..."
mise x -- hyperfine --export-json target/${BENCH_NAME}_hyperfine.json -L num_records 500,1000,10000 --runs 2 "NUM_RECORDS={num_records} ./target/release/$BENCH_NAME"

echo "Combining results..."
./target/release/combine_benchmark "$BENCH_NAME"

echo "Benchmark complete! Results written to results/ingest/${BENCH_NAME}_combined.json"
"""

[tasks."bench:ingest:encrypt_int"]
description = "Run encrypt_int ingest benchmark and combine results"
run = "mise run bench:ingest:_run encrypt_int"

[tasks."bench:ingest:encrypt_string"]
description = "Run encrypt_string ingest benchmark and combine results"
run = "mise run bench:ingest:_run encrypt_string"

[tasks."bench:ingest:encrypt_json_small"]
description = "Run encrypt_json_small ingest benchmark and combine results"
run = "mise run bench:ingest:_run encrypt_json_small"

[tasks."bench:ingest"]
description = "Run all ingest benchmarks sequentially"
depends = ["bench:ingest:encrypt_int", "bench:ingest:encrypt_string", "bench:ingest:encrypt_json_small"]
