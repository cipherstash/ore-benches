[tools]
rust = "latest"

[tasks.postgres]
description = "Start PostgreSQL via Docker Compose"
run = "docker compose up -d postgres"

[tasks.postgres-stop]
description = "Stop PostgreSQL Docker container"
run = "docker compose down"

[tasks.postgres-logs]
description = "View PostgreSQL logs"
run = "docker compose logs -f postgres"

[tasks.psql]
description = "Connect to PostgreSQL via psql"
run = "docker exec -it ore-benches-postgres psql -U postgres -d postgres"

[tasks.reset-db]
description = "Reset the database (drop and recreate)"
depends = ["postgres"]
run = """
#!/usr/bin/env bash
set -e

echo "Waiting for PostgreSQL to be ready..."
until docker exec ore-benches-postgres pg_isready -U postgres > /dev/null 2>&1; do
  sleep 1
done

echo "Dropping and recreating database..."
docker exec -i ore-benches-postgres psql -U postgres -d template1 -c "DROP DATABASE IF EXISTS postgres WITH (FORCE);"
docker exec -i ore-benches-postgres psql -U postgres -d template1 -c "CREATE DATABASE postgres;"

echo "Database reset complete. Run 'mise run setup-db' to set up tables and data."
"""

[tasks.setup-db]
description = "Set up the test database (create tables and load data)"
depends = ["postgres"]
run = """
#!/usr/bin/env bash
set -e

echo "Waiting for PostgreSQL to be ready..."
until docker exec ore-benches-postgres pg_isready -U postgres > /dev/null 2>&1; do
  sleep 1
done

echo "Downloading EQL..."
curl -sLo /tmp/cipherstash-encrypt.sql https://github.com/cipherstash/encrypt-query-language/releases/latest/download/cipherstash-encrypt.sql

echo "Installing EQL..."
docker exec -i ore-benches-postgres psql -v ON_ERROR_STOP=1 -U postgres -d postgres < /tmp/cipherstash-encrypt.sql

echo "Creating tables..."
docker exec -i ore-benches-postgres psql -v ON_ERROR_STOP=1 -U postgres -d postgres < sql/schema.sql

echo "Database setup complete!"
"""

[tasks."bench:build"]
description = "Build all binaries in release mode"
run = """
#!/usr/bin/env bash
set -e

echo "Building binaries in release mode..."
cargo build --release
"""

[tasks."bench:ingest:_run"]
description = "Internal: Run a generic ingest benchmark"
depends = ["bench:build"]
run = """
#!/usr/bin/env bash
set -e

BENCH_NAME="$1"

if [ -z "$BENCH_NAME" ]; then
  echo "Error: BENCH_NAME argument must be provided"
  exit 1
fi

echo "Running $BENCH_NAME ingest benchmark..."
mise x -- hyperfine --export-json target/${BENCH_NAME}_hyperfine.json -L num_records 500,1000,10000 --runs 2 "NUM_RECORDS={num_records} ./target/release/$BENCH_NAME"

echo "Combining results..."
./target/release/combine_benchmark "$BENCH_NAME"

echo "Benchmark complete! Results written to results/ingest/${BENCH_NAME}_combined.json"
"""

[tasks."bench:ingest:encrypt_int"]
description = "Run encrypt_int ingest benchmark and combine results"
run = "mise run bench:ingest:_run encrypt_int"

[tasks."bench:ingest:encrypt_string"]
description = "Run encrypt_string ingest benchmark and combine results"
run = "mise run bench:ingest:_run encrypt_string"

[tasks."bench:ingest:encrypt_json_small"]
description = "Run encrypt_json_small ingest benchmark and combine results"
run = "mise run bench:ingest:_run encrypt_json_small"

[tasks."bench:ingest"]
description = "Run all ingest benchmarks sequentially"
depends = ["bench:ingest:encrypt_int", "bench:ingest:encrypt_string", "bench:ingest:encrypt_json_small"]

[tasks."prepare:string_encrypted"]
description = "Prepare string_encrypted table with target row count"
depends = ["postgres", "bench:build"]
run = """
#!/usr/bin/env bash
set -e

TARGET_ROWS="$1"

if [ -z "$TARGET_ROWS" ]; then
  echo "Error: target row count argument required"
  echo "Usage: mise run prepare:string_encrypted <target_rows>"
  exit 1
fi

if ! [[ "$TARGET_ROWS" =~ ^[0-9]+$ ]]; then
  echo "Error: target row count must be a positive integer"
  exit 1
fi

echo "Waiting for PostgreSQL to be ready..."
until docker exec ore-benches-postgres pg_isready -U postgres > /dev/null 2>&1; do
  sleep 1
done

echo "Counting rows in string_encrypted table..."
CURRENT_ROWS=$(docker exec ore-benches-postgres psql -U postgres -d postgres -t -c "SELECT COUNT(*) FROM string_encrypted;" | tr -d ' ')

echo "Current rows: $CURRENT_ROWS"
echo "Target rows: $TARGET_ROWS"

echo "Dropping indexes..."
docker exec -i ore-benches-postgres psql -U postgres -d postgres < sql/indexes/string_encrypted_down.sql

if [ "$CURRENT_ROWS" -lt "$TARGET_ROWS" ]; then
  ROWS_TO_INSERT=$((TARGET_ROWS - CURRENT_ROWS))
  echo "Inserting $ROWS_TO_INSERT additional rows..."
  NUM_RECORDS=$ROWS_TO_INSERT ./target/release/encrypt_string
else
  echo "Truncating table and inserting $TARGET_ROWS rows..."
  docker exec ore-benches-postgres psql -U postgres -d postgres -c "TRUNCATE TABLE string_encrypted;"
  NUM_RECORDS=$TARGET_ROWS ./target/release/encrypt_string
fi

echo "Creating indexes..."
docker exec -i ore-benches-postgres psql -U postgres -d postgres < sql/indexes/string_encrypted_up.sql

FINAL_ROWS=$(docker exec ore-benches-postgres psql -U postgres -d postgres -t -c "SELECT COUNT(*) FROM string_encrypted;" | tr -d ' ')
echo "Preparation complete! Final row count: $FINAL_ROWS"
"""
